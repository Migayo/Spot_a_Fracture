#Installation and imports
!pip install -q -U keras-tuner
import tensorflow as tf
import keras_tuner as kt

# Load the Fashion MNIST dataset
(img_train, label_train), (img_test, label_test) = tf.keras.datasets.fashion_mnist.load_data()

# Normalize pixel values between 0 and 1
img_train = img_train.astype('float32') / 255.0
img_test = img_test.astype('float32') / 255.0

#Building a model
def model_builder(hp):
  model = tf.keras.Sequential()
  model.add(tf.keras.layers.Flatten(input_shape=(28, 28)))

  # Tune the number of dense layers
  for i in range(hp.Int('num_layers', 1, 5)):

    # Tune the number of units in the each dense layer
    hp_units = hp.Int('units_'+str(i), min_value=32, max_value=512, step=32)
    model.add(tf.keras.layers.Dense(units=hp_units, activation='relu'))

    # Tune the dropout rate in the each dense layer
    hp_dropout = hp.Float('rate', min_value=0.0, max_value=0.5, step=0.1)
    model.add(tf.keras.layers.Dropout(hp_dropout))

  # Add dense output layer
  model.add(tf.keras.layers.Dense(10, activation='softmax'))

  # Tune the learning rate for the optimizer
  hp_learning_rate = hp.Choice('learning_rate', values=[1e-2, 1e-3, 1e-4])
  model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=hp_learning_rate),
                loss='sparse_categorical_crossentropy',
                metrics=['accuracy'])

  return model

#Configuration of a Keras Tuner
tuner = kt.Hyperband(model_builder,
objective='val_accuracy',
max_epochs=10,
factor=3,
directory='keras_tuner',
project_name='fashion_mnist',
overwrite=True)

# Optimize the hyperparameter search for hypermodel
tuner.search(img_train, label_train, epochs=10, validation_split=0.2)

# Get the optimal hyperparameters
best_hps=tuner.get_best_hyperparameters(num_trials=1)[0]

import keras
# Build the model with the optimal hyperparameters and train it on the data for 50 epochs
model = tuner.hypermodel.build(best_hps)
model.summary()
my_callbacks = [
                keras.callbacks.EarlyStopping(patience=5,restore_best_weights=True),
                # keras.callbacks.ModelCheckpoint("my_resnet50_model.h5", save_best_only=True)
                ]
history = model.fit(img_train, label_train, epochs=50, validation_split=0.2)

# Evaluate the test performance of the tuned model
eval_result = model.evaluate(img_test, label_test)
print("[test loss, test accuracy]:", eval_result)
